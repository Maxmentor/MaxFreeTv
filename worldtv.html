<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>WorldTV</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="style.css">
</head>

<body class="dark">

<header>
  <h1>WorldTV</h1>
  <a class="slogan" href="https://github.com/Maxmentor" target="_blank">
    by Maxmentor
  </a>
  <button id="mode">ğŸŒ™ / â˜€ï¸</button>
</header>

<input type="text" id="search" placeholder="Search channel...">

<div id="channels"></div>

<script>
let allChannels = [];
let visibleChannels = [];
let batchSize = 100;   // Load 100 at a time
let currentIndex = 0;

// Load M3U
fetch('https://iptv-org.github.io/iptv/index.m3u')
  .then(res => res.text())
  .then(data => {
    allChannels = parseM3U(data);
    loadMore();
  });

// Parse M3U
function parseM3U(text) {
  const lines = text.split(/\r?\n/);
  const channels = [];

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i].trim();

    if (line.startsWith('#EXTINF:')) {
      const nameMatch = line.match(/,(.*)/);
      const name = nameMatch ? nameMatch[1].trim() : 'No Name';

      const logoMatch = line.match(/tvg-logo="(.*?)"/);
      const logo = logoMatch ? logoMatch[1] : 'https://www.freeiconspng.com/thumbs/television-icon/tv-icon-13.png';

      const url = lines[i + 1] ? lines[i + 1].trim() : '';

      if (url.startsWith('http')) {
        channels.push({ name, logo, url });
      }

      i++;
    }
  }

  return channels;
}

// Load batch
function loadMore(){
  const next = allChannels.slice(currentIndex, currentIndex + batchSize);
  currentIndex += batchSize;
  visibleChannels = visibleChannels.concat(next);
  render(next, true);
}

// Render
function render(list, append=false){
  const box = document.getElementById('channels');
  if(!append) box.innerHTML = '';

  const fragment = document.createDocumentFragment();

  list.forEach(ch => {
    const div = document.createElement('div');
    div.className = 'card';

    div.innerHTML = `
      <img src="${ch.logo}" onerror="this.src='https://via.placeholder.com/70'">
      <p>${ch.name}</p>
    `;

    div.onclick = () => {
      location.href = `player.html?src=${encodeURIComponent(ch.url)}`;
    };

    fragment.appendChild(div);
  });

  box.appendChild(fragment);
}

// Infinite scroll
window.addEventListener('scroll', () => {
  if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 300) {
    if (currentIndex < allChannels.length) {
      loadMore();
    }
  }
});

// Search fast
document.getElementById('search').addEventListener('input', e => {
  const value = e.target.value.toLowerCase();

  if(value === ''){
    currentIndex = 0;
    visibleChannels = [];
    document.getElementById('channels').innerHTML = '';
    loadMore();
    return;
  }

  const filtered = allChannels.filter(c =>
    c.name.toLowerCase().includes(value)
  );

  render(filtered.slice(0,500)); // limit search result for speed
});

// Dark/Light
document.getElementById('mode').onclick = () => {
  document.body.classList.toggle('light');
};
</script>

</body>
</html>
